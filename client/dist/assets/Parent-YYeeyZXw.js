import{az as e,k as a,o as s,B as n,z as t,aL as i,T as r,aF as l,X as o,bc as c,s as m,x as d,F as u,bd as h,ax as p,be as g,bf as x,bg as j,bh as _,bi as f,bj as b,bk as w}from"./index-DJgzJvx0.js";import{r as y}from"./vendor-kOq7Q5-U.js";import{I as k}from"./InfiniteScrollList-CRQVFRuq.js";import{T as S}from"./index-A8UrXWNV.js";import{P as v}from"./pencil-BHIqPcQ5.js";import{T as C}from"./trash-2-AcrYeN4V.js";import{C as T}from"./chevron-down-BfyMiLlt.js";import{D as I}from"./index-Ddh-PgSR.js";import{S as N}from"./search-DCbkSk8T.js";import{S as O}from"./index-ZAZRIL-n.js";import{P as z}from"./plus-BlyBk2I3.js";import{utils as E,writeFile as A,read as $}from"./xlsx-3FAc2Sll.js";import{D as B}from"./Drawer-ChV9KZXN.js";import{U as F}from"./index-DKe4wx0O.js";import{A as P}from"./index-D-YBaVh2.js";import{S as D}from"./index-l_qaOEJz.js";import{M}from"./index-CWRbA1GH.js";import"./charts-4CCI6hAs.js";import"./index-CsPvpU6M.js";import"./index-BzygXUWO.js";import"./useClosable-BMlLLbW6.js";import"./context-Co2t6AGx.js";import"./useMergedMask-hWGqm8nf.js";import"./DeleteOutlined-B97TiFIe.js";import"./progress-BgTHiS06.js";import"./ActionButton-DZkZ4UyV.js";const L=e("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),G=e("mail",[["path",{d:"m22 7-8.991 5.727a2 2 0 0 1-2.009 0L2 7",key:"132q7q"}],["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}]]),H=e("phone",[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]]),{Text:R}=r,V=e=>{const r=a.c(78),{item:d,index:u,onEdit:h,onDelete:p,isSelected:g,onSelectChange:x}=e,j=u+1;let _,f,b,w,y;r[0]===Symbol.for("react.memo_cache_sentinel")?(_=s.jsx(v,{size:14}),r[0]=_):_=r[0],r[1]!==d.id||r[2]!==h?(f={key:"edit",icon:_,label:"Edit Orang Tua",onClick:()=>h(d.id)},r[1]=d.id,r[2]=h,r[3]=f):f=r[3],r[4]===Symbol.for("react.memo_cache_sentinel")?(b=s.jsx(C,{size:14}),r[4]=b):b=r[4],r[5]!==d.full_name||r[6]!==d.id||r[7]!==p?(w={key:"delete",icon:b,label:"Hapus Orang Tua",danger:!0,onClick:()=>p({id:d.id,full_name:d.full_name})},r[5]=d.full_name,r[6]=d.id,r[7]=p,r[8]=w):w=r[8],r[9]!==f||r[10]!==w?(y=[f,w],r[9]=f,r[10]=w,r[11]=y):y=r[11];const k=y;let N,O;r[12]===Symbol.for("react.memo_cache_sentinel")?(N={borderRadius:12,height:"100%"},O={body:{padding:14}},r[12]=N,r[13]=O):(N=r[12],O=r[13]);const z=!!g;let E,A,$,B,F,P,D,M,V,U,K;r[14]!==d.id||r[15]!==x?(E=e=>x?.(d.id,e.target.checked),r[14]=d.id,r[15]=x,r[16]=E):E=r[16],r[17]!==z||r[18]!==E?(A=s.jsx(l,{checked:z,onChange:E}),r[17]=z,r[18]=E,r[19]=A):A=r[19],r[20]!==j?($=s.jsxs(R,{type:"secondary",children:["#",j]}),r[20]=j,r[21]=$):$=r[21],r[22]!==A||r[23]!==$?(B=s.jsxs(o,{size:8,align:"center",children:[A,$]}),r[22]=A,r[23]=$,r[24]=B):B=r[24],r[25]!==k?(F={items:k},r[25]=k,r[26]=F):F=r[26],r[27]===Symbol.for("react.memo_cache_sentinel")?(P=["click"],r[27]=P):P=r[27],r[28]===Symbol.for("react.memo_cache_sentinel")?(D=s.jsx(n,{size:"small",children:s.jsxs(o,{size:6,children:["Aksi",s.jsx(T,{size:14})]})}),r[28]=D):D=r[28],r[29]!==F?(M=s.jsx(c,{menu:F,trigger:P,children:D}),r[29]=F,r[30]=M):M=r[30],r[31]!==B||r[32]!==M?(V=s.jsxs(i,{justify:"space-between",align:"center",gap:8,children:[B,M]}),r[31]=B,r[32]=M,r[33]=V):V=r[33],r[34]===Symbol.for("react.memo_cache_sentinel")?(U={fontSize:20,lineHeight:1.2},r[34]=U):U=r[34],r[35]!==d.full_name?(K={tooltip:d.full_name},r[35]=d.full_name,r[36]=K):K=r[36];const W=d.full_name||"-";let J;r[37]!==K||r[38]!==W?(J=s.jsx(R,{strong:!0,style:U,ellipsis:K,children:W}),r[37]=K,r[38]=W,r[39]=J):J=r[39];const X=d.username||"-";let Y,Q;r[40]!==X?(Y=s.jsxs(R,{type:"secondary",children:["@",X]}),r[40]=X,r[41]=Y):Y=r[41],r[42]!==J||r[43]!==Y?(Q=s.jsxs(i,{vertical:!0,gap:2,children:[J,Y]}),r[42]=J,r[43]=Y,r[44]=Q):Q=r[44];const Z=d.is_active?"green":"default",ee=d.is_active?"Akun Aktif":"Akun Nonaktif";let ae;r[45]!==Z||r[46]!==ee?(ae=s.jsx(S,{color:Z,children:ee}),r[45]=Z,r[46]=ee,r[47]=ae):ae=r[47];const se=d.student_count||0;let ne,te,ie,re;r[48]!==se?(ne=s.jsxs(S,{color:"blue",children:[se," siswa"]}),r[48]=se,r[49]=ne):ne=r[49],r[50]!==ae||r[51]!==ne?(te=s.jsxs(i,{wrap:"wrap",gap:8,children:[ae,ne]}),r[50]=ae,r[51]=ne,r[52]=te):te=r[52],r[53]===Symbol.for("react.memo_cache_sentinel")?(ie=s.jsx(R,{type:"secondary",children:"Kontak"}),r[53]=ie):ie=r[53],r[54]===Symbol.for("react.memo_cache_sentinel")?(re=s.jsx(G,{size:14}),r[54]=re):re=r[54];const le=d.email||"-";let oe,ce,me,de;r[55]!==le?(oe=s.jsx(R,{children:le}),r[55]=le,r[56]=oe):oe=r[56],r[57]!==d.email?(ce=d.email?s.jsx(n,{type:"text",size:"small",icon:s.jsx(L,{size:14}),onClick:()=>{navigator.clipboard.writeText(d.email),t.success("Email disalin.")}}):null,r[57]=d.email,r[58]=ce):ce=r[58],r[59]!==oe||r[60]!==ce?(me=s.jsxs(o,{size:8,wrap:!0,children:[re,oe,ce]}),r[59]=oe,r[60]=ce,r[61]=me):me=r[61],r[62]===Symbol.for("react.memo_cache_sentinel")?(de=s.jsx(H,{size:14}),r[62]=de):de=r[62];const ue=d.phone||"-";let he,pe,ge,xe,je,_e;return r[63]!==ue?(he=s.jsxs(o,{size:8,wrap:!0,children:[de,s.jsx(R,{children:ue})]}),r[63]=ue,r[64]=he):he=r[64],r[65]!==me||r[66]!==he?(pe=s.jsxs(i,{vertical:!0,gap:8,children:[ie,me,he]}),r[65]=me,r[66]=he,r[67]=pe):pe=r[67],r[68]===Symbol.for("react.memo_cache_sentinel")?(ge=s.jsx(I,{style:{margin:"2px 0"}}),r[68]=ge):ge=r[68],r[69]===Symbol.for("react.memo_cache_sentinel")?(xe=s.jsx(R,{type:"secondary",children:"Daftar Siswa"}),r[69]=xe):xe=r[69],r[70]!==d.students?(je=s.jsxs(i,{vertical:!0,gap:8,children:[xe,Array.isArray(d.students)&&d.students.length>0?s.jsx(i,{wrap:"wrap",gap:6,children:d.students.map(q)}):s.jsx(R,{type:"secondary",children:"Belum ada siswa terhubung."})]}),r[70]=d.students,r[71]=je):je=r[71],r[72]!==V||r[73]!==Q||r[74]!==te||r[75]!==pe||r[76]!==je?(_e=s.jsx(m,{bordered:!0,hoverable:!0,style:N,styles:O,children:s.jsxs(i,{vertical:!0,gap:12,children:[V,Q,te,pe,ge,je]})}),r[72]=V,r[73]=Q,r[74]=te,r[75]=pe,r[76]=je,r[77]=_e):_e=r[77],_e};function q(e){return s.jsxs(S,{children:[e.nis||"-"," - ",e.full_name||"-",e.class_name?` (${e.class_name})`:""]},e.student_id)}const{Text:U}=r,K=e=>{const t=a.c(82),{screens:r,searchText:c,onSearchChange:m,gradeFilter:u,classFilter:h,gradeOptions:p,classOptions:g,onChangeGradeFilter:x,onChangeClassFilter:j,onCreate:_,selectedCount:f,onBulkDelete:b,isBulkDeleting:w,visibleCount:y,allVisibleSelected:k,onToggleSelectAllVisible:S,onClearSelection:v}=e,T=void 0===f?0:f,I=void 0!==w&&w,E=void 0===y?0:y,A=void 0!==k&&k;let $;t[0]===Symbol.for("react.memo_cache_sentinel")?($={marginBottom:16},t[0]=$):$=t[0];const B=r.xs?"stretch":"center",F=r.xs?"100%":"auto";let P,D,M;t[1]!==F?(P={width:F},t[1]=F,t[2]=P):P=t[2],t[3]!==m?(D=e=>m(e.target.value),t[3]=m,t[4]=D):D=t[4],t[5]===Symbol.for("react.memo_cache_sentinel")?(M=s.jsx(N,{size:16}),t[5]=M):M=t[5];const L=r.xs?"100%":420;let G,H;t[6]!==L?(G={width:L},t[6]=L,t[7]=G):G=t[7],t[8]!==c||t[9]!==G||t[10]!==D?(H=s.jsx(d,{allowClear:!0,value:c,onChange:D,placeholder:"Cari nama orang tua, username, email, atau NIS siswa",prefix:M,style:G}),t[8]=c,t[9]=G,t[10]=D,t[11]=H):H=t[11];const R=r.xs?"100%":190;let V,q;t[12]!==R?(V={width:R},t[12]=R,t[13]=V):V=t[13],t[14]!==u||t[15]!==p||t[16]!==x||t[17]!==V?(q=s.jsx(O,{allowClear:!0,placeholder:"Filter tingkat",value:u,options:p,onChange:x,style:V}),t[14]=u,t[15]=p,t[16]=x,t[17]=V,t[18]=q):q=t[18];const K=!!u&&0===g.length,W=r.xs?"100%":220;let J,X,Y;t[19]!==W?(J={width:W},t[19]=W,t[20]=J):J=t[20],t[21]!==h||t[22]!==g||t[23]!==j||t[24]!==K||t[25]!==J?(X=s.jsx(O,{allowClear:!0,placeholder:"Filter kelas",value:h,options:g,onChange:j,disabled:K,style:J}),t[21]=h,t[22]=g,t[23]=j,t[24]=K,t[25]=J,t[26]=X):X=t[26],t[27]!==H||t[28]!==q||t[29]!==X||t[30]!==P?(Y=s.jsxs(i,{gap:8,wrap:"wrap",style:P,children:[H,q,X]}),t[27]=H,t[28]=q,t[29]=X,t[30]=P,t[31]=Y):Y=t[31];const Q=r.xs?"100%":"auto";let Z,ee;t[32]!==Q?(Z={width:Q},t[32]=Q,t[33]=Z):Z=t[33],t[34]===Symbol.for("react.memo_cache_sentinel")?(ee=s.jsx(C,{size:16}),t[34]=ee):ee=t[34];const ae=0===T,se=r.xs?"100%":"auto";let ne;t[35]!==se?(ne={width:se},t[35]=se,t[36]=ne):ne=t[36];const te=T>0?`(${T})`:"";let ie,re;t[37]!==I||t[38]!==b||t[39]!==ae||t[40]!==ne||t[41]!==te?(ie=s.jsxs(n,{danger:!0,icon:ee,onClick:b,disabled:ae,loading:I,style:ne,children:["Hapus Terpilih ",te]}),t[37]=I,t[38]=b,t[39]=ae,t[40]=ne,t[41]=te,t[42]=ie):ie=t[42],t[43]===Symbol.for("react.memo_cache_sentinel")?(re=s.jsx(z,{size:16}),t[43]=re):re=t[43];const le=r.xs?"100%":"auto";let oe,ce,me,de;t[44]!==le?(oe={width:le},t[44]=le,t[45]=oe):oe=t[45],t[46]!==_||t[47]!==oe?(ce=s.jsx(n,{type:"primary",icon:re,onClick:_,style:oe,children:"Tambah Orang Tua"}),t[46]=_,t[47]=oe,t[48]=ce):ce=t[48],t[49]!==Z||t[50]!==ie||t[51]!==ce?(me=s.jsxs(i,{gap:8,wrap:"wrap",style:Z,children:[ie,ce]}),t[49]=Z,t[50]=ie,t[51]=ce,t[52]=me):me=t[52],t[53]!==r.xs||t[54]!==Y||t[55]!==me||t[56]!==B?(de=s.jsxs(i,{justify:"space-between",align:B,vertical:r.xs,gap:12,children:[Y,me]}),t[53]=r.xs,t[54]=Y,t[55]=me,t[56]=B,t[57]=de):de=t[57];const ue=r.xs?"stretch":"center",he=!A&&T>0,pe=0===E;let ge,xe,je,_e;t[58]!==S?(ge=e=>S?.(e.target.checked),t[58]=S,t[59]=ge):ge=t[59],t[60]!==A||t[61]!==he||t[62]!==pe||t[63]!==ge?(xe=s.jsx(l,{checked:A,indeterminate:he,disabled:pe,onChange:ge,children:"Pilih semua data terlihat"}),t[60]=A,t[61]=he,t[62]=pe,t[63]=ge,t[64]=xe):xe=t[64],t[65]!==T?(je=s.jsxs(U,{type:"secondary",children:[T," dipilih"]}),t[65]=T,t[66]=je):je=t[66],t[67]!==xe||t[68]!==je?(_e=s.jsxs(o,{size:12,wrap:!0,children:[xe,je]}),t[67]=xe,t[68]=je,t[69]=_e):_e=t[69];const fe=0===T;let be,we,ye,ke;return t[70]!==v||t[71]!==fe?(be=s.jsx(n,{type:"text",onClick:v,disabled:fe,children:"Reset Pilihan"}),t[70]=v,t[71]=fe,t[72]=be):be=t[72],t[73]!==r.xs||t[74]!==ue||t[75]!==_e||t[76]!==be?(we=s.jsxs(i,{justify:"space-between",align:ue,vertical:r.xs,gap:8,children:[_e,be]}),t[73]=r.xs,t[74]=ue,t[75]=_e,t[76]=be,t[77]=we):we=t[77],t[78]===Symbol.for("react.memo_cache_sentinel")?(ye=s.jsxs(U,{type:"secondary",children:["Tips: gunakan checkbox untuk seleksi massal lalu klik ",s.jsx("strong",{children:"Hapus Terpilih"}),"."]}),t[78]=ye):ye=t[78],t[79]!==de||t[80]!==we?(ke=s.jsxs(i,{vertical:!0,gap:10,style:$,children:[de,we,ye]}),t[79]=de,t[80]=we,t[81]=ke):ke=t[81],ke},{Text:W,Title:J}=r,X=({screens:e,open:a,editingParent:r,form:l,onClose:c,onSubmit:p,onImportExcel:g,isSubmitting:x,isImporting:j,studentOptions:_})=>{const[f,b]=y.useState("manual"),w=r?"manual":f,k=()=>{b("manual"),c()},S=e=>String(e??"").trim(),v=(e,a)=>{for(const s of a)if(void 0!==e[s]&&null!==e[s])return e[s];return""};return s.jsx(B,{title:s.jsxs(i,{align:"center",justify:"space-between",gap:12,wrap:"wrap",children:[s.jsx("span",{children:r?"Edit Orang Tua":"Tambah Orang Tua"}),r?null:s.jsx(h,{value:w,onChange:b,options:[{label:"Tambah Manual",value:"manual"},{label:"Import Excel",value:"import"}]})]}),width:e.xs?"100%":560,open:a,onClose:k,destroyOnHidden:!0,children:r||"import"!==w?s.jsxs(u,{form:l,layout:"vertical",initialValues:{is_active:!0},children:[s.jsx(u.Item,{label:"Nama Lengkap",name:"full_name",rules:[{required:!0,message:"Nama lengkap wajib diisi."}],children:s.jsx(d,{placeholder:"Nama orang tua"})}),s.jsx(u.Item,{label:"Username",name:"username",rules:[{required:!0,message:"Username wajib diisi."}],children:s.jsx(d,{placeholder:"Username login orang tua"})}),s.jsx(u.Item,{label:r?"Password Baru (Opsional)":"Password",name:"password",rules:r?[]:[{required:!0,message:"Password wajib diisi."}],children:s.jsx(d.Password,{placeholder:"Masukkan password"})}),s.jsx(u.Item,{label:"Email",name:"email",children:s.jsx(d,{placeholder:"Email orang tua"})}),s.jsx(u.Item,{label:"No. HP",name:"phone",children:s.jsx(d,{placeholder:"Nomor telepon"})}),s.jsx(u.Item,{label:"Tambah Siswa Berdasarkan NIS",name:"nis_list",rules:[{required:!0,message:"Minimal 1 siswa wajib ditambahkan."}],extra:"Siswa yang sudah terhubung ke orang tua lain otomatis dinonaktifkan.",children:s.jsx(O,{mode:"multiple",showSearch:{optionFilterProp:"label"},allowClear:!0,placeholder:"Pilih NIS siswa",options:_,virtual:!1})}),s.jsx(u.Item,{label:"Status Akun",name:"is_active",valuePropName:"checked",children:s.jsx(D,{checkedChildren:"Aktif",unCheckedChildren:"Nonaktif"})}),s.jsx(u.Item,{style:{marginBottom:0},children:s.jsxs(i,{justify:"end",gap:8,children:[s.jsx(n,{onClick:k,children:"Batal"}),s.jsx(n,{type:"primary",loading:x,onClick:p,children:"Simpan"})]})})]}):s.jsxs(m,{size:"small",children:[s.jsxs(i,{justify:"space-between",align:"start",gap:12,wrap:"wrap",children:[s.jsxs("div",{children:[s.jsx(J,{level:5,style:{margin:0},children:"Import Data Orang Tua"}),s.jsx(W,{type:"secondary",children:"Download template, isi data, lalu upload file Excel."})]}),s.jsxs(o,{wrap:!0,children:[s.jsx(n,{onClick:()=>{const e=E.book_new();E.book_append_sheet(e,E.json_to_sheet([{username:"wali_ahmad",full_name:"Bapak Ahmad",password:"Rahasia123!",email:"ahmad@mail.com",phone:"081234567890",nis_list:"10001,10002"},{username:"wali_siti",full_name:"Ibu Siti",password:"Rahasia123!",email:"siti@mail.com",phone:"081298765432",nis_list:"10003"}]),"Template_OrangTua"),E.book_append_sheet(e,E.json_to_sheet([{kolom:"username",keterangan:"Wajib. Harus unik untuk setiap akun orang tua."},{kolom:"full_name",keterangan:"Wajib. Nama lengkap orang tua."},{kolom:"password",keterangan:"Wajib. Password awal akun orang tua."},{kolom:"email",keterangan:"Opsional. Email orang tua."},{kolom:"phone",keterangan:"Opsional. Nomor HP orang tua."},{kolom:"nis_list",keterangan:"Wajib. Isi NIS siswa, pisahkan dengan koma. Contoh: 10001,10002"},{kolom:"Catatan",keterangan:"Jika username sama di beberapa baris, sistem akan menggabungkan semua NIS menjadi satu akun orang tua."}]),"Panduan"),A(e,"Template_Import_Orang_Tua.xlsx")},children:"Download Template"}),s.jsx(F,{accept:".xlsx,.xls",showUploadList:!1,beforeUpload:async e=>{if(!g)return F.LIST_IGNORE;try{const a=await e.arrayBuffer(),s=$(a,{type:"array"}),n=s.SheetNames[0];if(!n)return t.error("Sheet Excel tidak ditemukan."),F.LIST_IGNORE;const i=s.Sheets[n],r=E.sheet_to_json(i,{defval:"",raw:!1});if(!r.length)return t.error("Data Excel kosong."),F.LIST_IGNORE;const l=new Map,o=[];r.forEach((e,a)=>{const s={};Object.entries(e).forEach(([e,a])=>{var n;s[(n=e,String(n||"").trim().toLowerCase().replace(/\s+/g,"_"))]=a});const n=S(v(s,["username","user_name","user"])),t=S(v(s,["full_name","nama_lengkap","nama"])),i=S(v(s,["password","kata_sandi"])),r=S(v(s,["email","mail"])),c=S(v(s,["phone","no_hp","nohp","nomor_hp","no_telp"])),m=v(s,["nis_list","nis","student_nis","siswa_nis"]),d=(u=m,Array.from(new Set(String(u||"").split(/[\n,;|]/).map(e=>e.trim()).filter(Boolean))));var u;if(!n||!t||!i||0===d.length)return void o.push(a+2);const h=n.toLowerCase(),p=l.get(h);p?(p.nis_list=Array.from(new Set([...p.nis_list,...d])),!p.full_name&&t&&(p.full_name=t),!p.password&&i&&(p.password=i),!p.email&&r&&(p.email=r),!p.phone&&c&&(p.phone=c)):l.set(h,{username:n,full_name:t,password:i,email:r||null,phone:c||null,is_active:!0,nis_list:d})});const c=Array.from(l.values());if(0===c.length)return t.error("Tidak ada baris valid untuk diimport."),F.LIST_IGNORE;if(o.length>0){const e=o.slice(0,8).join(", ");t.warning(`Sebagian baris dilewati (baris: ${e}${o.length>8?", dst":""}).`)}await g(c)}catch(a){t.error(a?.message||"Gagal membaca file Excel.")}return F.LIST_IGNORE},disabled:x||j,children:s.jsx(n,{type:"primary",loading:j,children:"Import Excel"})})]})]}),s.jsx(P,{style:{marginTop:12},type:"info",showIcon:!0,message:"Panduan Pengisian Template",description:s.jsxs("div",{children:[s.jsx("div",{children:"1. Kolom wajib: username, full_name, password, nis_list."}),s.jsx("div",{children:"2. Kolom opsional: email, phone."}),s.jsx("div",{children:"3. Isi `nis_list` dengan pemisah koma untuk banyak siswa."}),s.jsx("div",{children:"4. Contoh: 10001,10002,10003."}),s.jsx("div",{children:"5. Username yang sama akan digabung menjadi satu akun orang tua."})]})})]})})},{Text:Y}=r,Q=()=>{const e=p.useBreakpoint(),[a]=u.useForm(),[n,r]=y.useState(1),[l]=y.useState(20),[o,c]=y.useState([]),[d,h]=y.useState(""),[S,v]=y.useState(""),[C,T]=y.useState(null),[N,O]=y.useState(null),[z,E]=y.useState(!1),[A,$]=y.useState(null),[B,F]=y.useState(!1),[P,D]=y.useState([]),{data:L,isFetching:G}=g({page:n,limit:l,search:S,grade_id:C,class_id:N}),{data:H}=x(),[R]=j(),[q,{isLoading:U}]=_(),[W,{isLoading:J}]=f(),[Q,{isLoading:Z}]=b(),[ee,{isLoading:ae}]=w();y.useEffect(()=>{const e=setTimeout(()=>{r(1),c([]),D([]),v(d.trim())},350);return()=>clearTimeout(e)},[d]),y.useEffect(()=>{r(1),c([]),D([])},[C,N]),y.useEffect(()=>{const e=L?.data||[],a=setTimeout(()=>{c(1!==n?a=>{const s=new Set(a.map(e=>e.id)),n=e.filter(e=>!s.has(e.id));return[...a,...n]}:e)},0);return()=>clearTimeout(a)},[L,n]);const se=L?.totalData||0,ne=o.length<se,te=y.useMemo(()=>o.map(e=>Number(e.id)).filter(e=>Number.isInteger(e)&&e>0),[o]),ie=te.length>0&&te.every(e=>P.includes(e)),re=H?.data?.active_periode||null,le=y.useMemo(()=>H?.data?.students??[],[H?.data?.students]),oe=y.useMemo(()=>{const e=new Map;return le.forEach(a=>{const s=Number(a.grade_id);s&&!e.has(s)&&e.set(s,{value:s,label:a.grade_name||`Tingkat ${s}`})}),Array.from(e.values()).sort((e,a)=>String(e.label).localeCompare(String(a.label)))},[le]),ce=y.useMemo(()=>{const e=new Map;return le.forEach(a=>{const s=Number(a.class_id||a.current_class_id),n=Number(a.grade_id);if(!s)return;if(C&&n!==Number(C))return;if(e.has(s))return;let t=a.class_name||`Kelas ${s}`;a.grade_name&&(t=`${a.grade_name} / ${t}`),e.set(s,{value:s,label:t})}),Array.from(e.values()).sort((e,a)=>String(e.label).localeCompare(String(a.label)))},[le,C]),me=y.useMemo(()=>le.map(e=>{const a=e.owner_parent_id,s=a&&Number(a)!==Number(A?.id);let n=`${e.nis||"-"} - ${e.full_name||"-"}`;return(e.grade_name||e.class_name)&&(n+=` (${e.grade_name||"-"}${e.class_name?` / ${e.class_name}`:""})`),s&&e.owner_parent_name&&(n+=` [Terhubung: ${e.owner_parent_name}]`),{value:e.nis,label:n,disabled:s}}),[le,A]),de=()=>{E(!1),$(null),a.resetFields()},ue=async e=>{var s;if(e)try{const n=await R(e).unwrap();s=n.data,$(s),a.setFieldsValue({username:s.username,full_name:s.full_name,phone:s.phone||"",email:s.email||"",is_active:!!s.is_active,nis_list:(s.students||[]).map(e=>e.nis).filter(Boolean),password:""}),E(!0)}catch(n){t.error(n?.data?.message||"Gagal memuat data orang tua.")}},he=e=>{M.confirm({title:"Hapus Orang Tua",content:`Yakin ingin menghapus akun ${e.full_name}?`,okText:"Hapus",okButtonProps:{danger:!0,loading:Z},cancelText:"Batal",onOk:async()=>{try{await Q(e.id).unwrap(),t.success("Orang tua berhasil dihapus."),r(1),c([]),D([])}catch(a){t.error(a?.data?.message||"Gagal menghapus data.")}}})},pe=(e,a)=>{D(s=>{const n=Number(e);return!Number.isInteger(n)||n<=0?s:a?Array.from(new Set([...s,n])):s.filter(e=>e!==n)})};return s.jsxs(i,{vertical:!0,gap:16,style:{overflowX:"hidden"},children:[s.jsxs(m,{variant:"borderless",style:{borderRadius:14,overflow:"hidden"},children:[s.jsx(K,{screens:e,searchText:d,onSearchChange:h,gradeFilter:C,classFilter:N,gradeOptions:oe,classOptions:ce,onChangeGradeFilter:e=>{T(e||null),O(null)},onChangeClassFilter:e=>{O(e||null)},onCreate:()=>{$(null),a.resetFields(),a.setFieldsValue({is_active:!0,nis_list:[]}),E(!0)},selectedCount:P.length,onBulkDelete:()=>{0!==P.length&&M.confirm({title:"Hapus Bulk Orang Tua",content:`Yakin ingin menghapus ${P.length} data orang tua terpilih?`,okText:"Hapus Semua",okButtonProps:{danger:!0,loading:ae},cancelText:"Batal",onOk:async()=>{try{const e=await ee(P).unwrap();t.success(e?.message||"Data orang tua berhasil dihapus."),D([]),r(1),c([])}catch(e){t.error(e?.data?.message||"Gagal menghapus data secara bulk.")}}})},isBulkDeleting:ae,visibleCount:te.length,allVisibleSelected:ie,onToggleSelectAllVisible:e=>{D(e?e=>Array.from(new Set([...e,...te])):e=>e.filter(e=>!te.includes(e)))},onClearSelection:()=>{D([])}}),s.jsx(k,{data:o,loading:G,hasMore:ne,onLoadMore:()=>{!G&&ne&&r(e=>e+1)},renderItem:(e,a)=>s.jsx(V,{item:e,index:a,onEdit:ue,onDelete:he,isSelected:P.includes(Number(e.id)),onSelectChange:pe}),emptyText:"Data orang tua tidak ditemukan",grid:{gutter:[12,12],xs:24,sm:24,md:12,lg:12,xl:8,xxl:8}}),s.jsx(I,{style:{margin:0}}),s.jsxs(i,{justify:"space-between",align:"center",style:{padding:"10px 14px"},children:[s.jsx(Y,{type:"secondary",children:o.length>0?`1-${o.length} dari ${se}`:`0 dari ${se}`}),s.jsxs(Y,{type:"secondary",children:["Periode Aktif: ",s.jsx(Y,{strong:!0,children:re?.name||"-"})]})]})]}),s.jsx(X,{screens:e,open:z,editingParent:A,form:a,onClose:de,onSubmit:async()=>{try{const e=await a.validateFields(),s={username:String(e.username||"").trim(),full_name:String(e.full_name||"").trim(),phone:e.phone?String(e.phone).trim():null,email:e.email?String(e.email).trim():null,is_active:!!e.is_active,nis_list:(e.nis_list||[]).map(e=>String(e).trim())};A?(e.password&&""!==String(e.password).trim()&&(s.password=String(e.password)),await W({id:A.id,...s}).unwrap(),t.success("Data orang tua berhasil diperbarui.")):(s.password=String(e.password||""),await q(s).unwrap(),t.success("Orang tua berhasil ditambahkan.")),de(),r(1),c([]),D([])}catch(e){if(e?.errorFields)return;t.error(e?.data?.message||"Gagal menyimpan data.")}},onImportExcel:async e=>{if(!Array.isArray(e)||0===e.length)return;const a=new Map(le.filter(e=>e?.nis).map(e=>[String(e.nis).trim(),e])),s=new Set,n=new Set,i=[];let l=0;F(!0);try{for(const t of e){const e=Array.from(new Set((t?.nis_list||[]).map(e=>String(e||"").trim()).filter(Boolean))),r=[];if(e.forEach(e=>{const t=a.get(e);t?t.owner_parent_id?n.add(e):r.push(e):s.add(e)}),0===r.length){i.push(String(t?.username||"-"));continue}const o={username:String(t?.username||"").trim(),full_name:String(t?.full_name||"").trim(),password:String(t?.password||""),phone:t?.phone?String(t.phone).trim():null,email:t?.email?String(t.email).trim():null,is_active:!1!==t?.is_active,nis_list:r};try{await q(o).unwrap(),l+=1}catch{i.push(o.username||"-")}}if(l>0&&(t.success(`Import selesai: ${l} data orang tua berhasil ditambahkan.`),r(1),c([]),D([])),i.length>0||s.size>0||n.size>0){const e=i.slice(0,5).join(", "),a=Array.from(s).slice(0,5).join(", "),r=Array.from(n).slice(0,5).join(", "),l=[];i.length>0&&l.push(`Gagal akun: ${e}${i.length>5?` (+${i.length-5} lainnya)`:""}`),s.size>0&&l.push(`NIS tidak ditemukan: ${a}${s.size>5?` (+${s.size-5} lainnya)`:""}`),n.size>0&&l.push(`NIS sudah terhubung: ${r}${n.size>5?` (+${n.size-5} lainnya)`:""}`),t.warning(l.join(" | "))}}finally{F(!1)}},isSubmitting:U||J,isImporting:B,studentOptions:me})]})};export{Q as default};

const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/GradingHeader-BO0ACP7e.js","assets/index-DJgzJvx0.js","assets/vendor-kOq7Q5-U.js","assets/charts-4CCI6hAs.js","assets/index-DOw7bMS2.css","assets/index-A8UrXWNV.js","assets/useClosable-BMlLLbW6.js","assets/info-B3dYydNr.js","assets/graduation-cap-DX8X8xmD.js","assets/calendar-check-D97wGW1w.js","assets/StudentGradingTable-qIYAzt8g.js","assets/dayjs.min-CGX6Te6V.js","assets/funnel-CQS6Mpx9.js","assets/index-C55hmNsY.js","assets/index-ZAZRIL-n.js","assets/index-CsPvpU6M.js"])))=>i.map(i=>d[i]);
import{m as e}from"./charts-4CCI6hAs.js";import{I as t,T as a,k as i,o as r,X as s,s as n,ej as l,ek as o,el as d,em as u,ba as c,b9 as m,en as p,eo as f,ep as h,eq as k,er as _,es as g,et as b,eu as y,aL as j,v as S,B as w,a0 as x,z as v}from"./index-DJgzJvx0.js";import{r as N}from"./vendor-kOq7Q5-U.js";import{utils as I,writeFile as E,read as A}from"./xlsx-3FAc2Sll.js";import{d as $}from"./dayjs.min-CGX6Te6V.js";import{F as M}from"./Table-Bpp4NRb8.js";import{T as C}from"./index-Dixg4MZV.js";import{S as z}from"./index-ZAZRIL-n.js";import{D as T}from"./download-CnFHAq_0.js";import{U}from"./index-DKe4wx0O.js";import{U as F}from"./upload-VxSW6h0e.js";import{S as B}from"./save-4y8l8Hx8.js";import{M as O}from"./index-CWRbA1GH.js";import{R as P}from"./DeleteOutlined-B97TiFIe.js";import{E as K}from"./index-CsPvpU6M.js";var L={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M464 688a48 48 0 1096 0 48 48 0 10-96 0zm24-112h48c4.4 0 8-3.6 8-8V296c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8z"}}]},name:"exclamation-circle",theme:"outlined"};function R(){return R=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i])}return e},R.apply(this,arguments)}const G=(e,a)=>N.createElement(t,R({},e,{ref:a,icon:L})),D=N.forwardRef(G),{Text:W}=a,H=e=>{const t=String(e||""),a=t.match(/-S(\d+)/);return a?Number(a[1]):/^M\d{2}-B\d+$/.test(t)?1:null},V=({students:e=[],isFormativeFilterActive:t,activeChapterId:a,activeChapter:i,chaptersWithContents:r=[]})=>{if(t){if(!a)return[];const t=new Set;e.forEach(e=>{(e.scores||[]).forEach(e=>{const a=H(e?.type);null!=a&&t.add(a)})});return Array.from(t).sort((e,t)=>Number(e)-Number(t)).map((e,t)=>({id:e,title:`Nilai ${t+1}`,labelIndex:t+1,scoreKey:e}))}const s=new Map((r||[]).map(e=>[String(e.id),e.title])),n=new Map;(r||[]).forEach(e=>{(e.contents||[]).forEach((t,a)=>{n.set(`${e.id}:${t.id}`,a+1)})});const l=new Map,o=new Map;e.forEach(e=>{(e.scores||[]).forEach(e=>{if(!e)return;const t=e.chapter_id??"0",a=`${e.month||"M00"}::${t}`,i=H(e.type);o.has(a)||o.set(a,new Set),null!=i&&o.get(a).add(i)})});const d=new Map;return o.forEach((e,t)=>{const a=Array.from(e).sort((e,t)=>Number(e)-Number(t)),i=new Map;a.forEach((e,t)=>{i.set(e,t+1)}),d.set(t,i)}),e.forEach(e=>{(e.scores||[]).forEach(e=>{if(!e)return;const t=e.type||`${e.month||"M00"}-B${e.chapter_id??"0"}-S${H(e.type)??"0"}`;if(l.has(t))return;const a=s.get(String(e.chapter_id))||`Bab ${e.chapter_id??"-"}`,i=e.month||"-",r=`${e.month||"M00"}::${e.chapter_id??"0"}`,o=H(e.type),u=null!=o?d.get(r)?.get(o):null,c=null!=o?n.get(`${e.chapter_id}:${o}`):null,m=u||c||1;l.set(t,{id:o??t,scoreKey:t,title:`${i} - ${a} - Nilai ${m}`,labelIndex:m})})}),Array.from(l.values())};function Y(e,t){const a=Number(e),i=Number(t),r=Number.isFinite(a)&&a>0,s=Number.isFinite(i)&&i>0;return r&&s?a-i:r?-1:s?1:e.localeCompare(t)}function J(e,t){const a=Number(e),i=Number.isFinite(a)&&a>0?a:t+1;return{id:e,scoreKey:e,labelIndex:i,title:`Nilai ${i}`}}function q(e){return String(e?.scoreKey??e?.id??e?.key??e?.value)}function Q(e){return e?.scoreKey??e?.id??e?.key??e?.value}function X(e){return e?.title||`Nilai ${e?.labelIndex??e?.id??"-"}`}function Z(e){return r.jsx(W,{children:e||"-"})}function ee(e){return r.jsx(W,{strong:!0,children:e})}function te(e,t){return r.jsxs(s,{orientation:"vertical",size:2,children:[r.jsx(W,{strong:!0,children:t.name}),r.jsx(W,{type:"secondary",style:{fontSize:12},children:t.nis||"-"})]})}function ae(e){return e.id}const ie=Object.freeze(Object.defineProperty({__proto__:null,buildFormatifSubchapters:V,default:e=>{const t=i.c(31),{students:a,isMobile:l,isFilterReady:o,onFormativeChange:d,subchapters:u}=e;let c;t[0]!==u?(c=void 0===u?[]:u,t[0]=u,t[1]=c):c=t[1];const m=c;let p;if(t[2]!==a||t[3]!==m){const e=Array.isArray(m)?m:[],i=new Set;(a||[]).forEach(e=>{const t=e?.formatifScores||{};Object.keys(t).forEach(e=>{"__new"!==e&&i.add(String(e))})});const r=Array.from(i).sort(Y).map(J);p=[...e];const s=new Set(e.map(q));r.forEach(e=>{const t=String(e.scoreKey);s.has(t)||(p.push(e),s.add(t))}),t[2]=a,t[3]=m,t[4]=p}else p=t[4];const f=p,h=Q,k=X;let _;t[5]!==o||t[6]!==l||t[7]!==d?(_=(e,t,a)=>{const i=h(a);return r.jsx(C,{min:0,max:100,step:1,precision:0,size:l?"small":"middle",style:{width:"100%"},value:e.formatifScores?.[i]??0,disabled:!o,onChange:e=>d(t,i,e)})},t[5]=o,t[6]=l,t[7]=d,t[8]=_):_=t[8];const g=_;let b,y,j,S,w,x;if(t[9]===Symbol.for("react.memo_cache_sentinel")?(b={title:"NIS",dataIndex:"nis",key:"nis",width:"14%",render:Z,responsive:["md"]},t[9]=b):b=t[9],t[10]===Symbol.for("react.memo_cache_sentinel")?(y={title:"Nama Siswa",dataIndex:"name",key:"name",width:"22%",render:ee,responsive:["md"]},t[10]=y):y=t[10],t[11]===Symbol.for("react.memo_cache_sentinel")?(j={title:"Siswa",key:"student",responsive:["xs"],render:te},t[11]=j):j=t[11],t[12]!==f||t[13]!==g?(S=f.map(e=>{const t=h(e);return{title:k(e),key:`sub_${t}`,width:"16%",render:(t,a,i)=>g(a,i,e)}}),t[12]=f,t[13]=g,t[14]=S):S=t[14],t[15]!==o||t[16]!==g||t[17]!==S){if(w=[b,y,j,...S],o){let e;t[19]!==g?(e={title:"Input Nilai",key:"sub_new",width:"16%",render:(e,t,a)=>g(t,a,{scoreKey:"__new",title:"Input Nilai"})},t[19]=g,t[20]=e):e=t[20],w.push(e)}t[15]=o,t[16]=g,t[17]=S,t[18]=w}else w=t[18];t[21]!==o||t[22]!==f||t[23]!==g?(x=(e,t)=>r.jsx(n,{size:"small",style:{borderRadius:12,border:"1px solid #f0f0f0"},styles:{body:{padding:12}},children:r.jsxs(s,{orientation:"vertical",size:8,style:{width:"100%"},children:[r.jsxs("div",{children:[r.jsx(W,{strong:!0,children:e.name}),r.jsx("div",{children:r.jsxs(W,{type:"secondary",style:{fontSize:12},children:["NIS: ",e.nis||"-"]})})]}),r.jsxs("div",{style:{display:"grid",gap:8},children:[f.map(a=>r.jsxs("div",{children:[r.jsx(W,{type:"secondary",children:k(a)}),g(e,t,a)]},`sub_mobile_${h(a)}`)),o&&r.jsxs("div",{children:[r.jsx(W,{type:"secondary",children:"Input Nilai"}),g(e,t,{scoreKey:"__new"})]},"sub_mobile_new")]})]})},e.id),t[21]=o,t[22]=f,t[23]=g,t[24]=x):x=t[24];const v=x;let N;return t[25]!==w||t[26]!==l||t[27]!==f.length||t[28]!==v||t[29]!==a?(N=l?r.jsx(s,{orientation:"vertical",size:12,style:{width:"100%"},children:(a||[]).map((e,t)=>v(e,t))}):r.jsx(M,{dataSource:a,columns:w,rowKey:ae,pagination:!1,size:"middle",tableLayout:"fixed",scroll:f.length>3?{x:900}:void 0,locale:{emptyText:"Belum ada siswa di kelas ini."}}),t[25]=w,t[26]=l,t[27]=f.length,t[28]=v,t[29]=a,t[30]=N):N=t[30],N},extractSubIdFromType:H},Symbol.toStringTag,{value:"Module"})),re=N.lazy(()=>e(()=>import("./GradingHeader-BO0ACP7e.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))),se=N.lazy(()=>e(()=>import("./StudentGradingTable-qIYAzt8g.js"),__vite__mapDeps([10,3,2,1,4,11,12,13,14,15]))),ne=Object.freeze(Object.defineProperty({__proto__:null,default:({subject:e})=>{const{data:t}=l(),i=t?.data?.homebase||null,s=t?.data?.activePeriode||null,M=N.useMemo(()=>i?[{id:i.id,name:i.name,level:i.level}]:[],[i]),C=N.useMemo(()=>s?[{id:s.id,name:s.name,start:s.start,end:s.end,isActive:!0}]:[],[s]),L=M[0]?.id,R=C[0]?.id,{data:G}=o({subjectId:e?.id},{skip:!e?.id}),W=G?.data||[],[Y,J]=N.useState(null),[q,Q]=N.useState("semester1"),[X,Z]=N.useState("sikap");N.useEffect(()=>{W.length?Y&&W.some(e=>String(e.id)===String(Y))||J(W[0]?.id):J(null)},[W,Y]);const{data:ee}=d({subjectId:e?.id,classId:Y},{skip:!e?.id||!Y}),te=M[0]||null,ae=C[0]||null,ie="semester1"===q?"Semester 1":"Semester 2",ne="semester1"===q?1:2,[le,oe]=N.useState([]),[de,ue]=N.useState(!1),[ce,me]=N.useState(!1),[pe,fe]=N.useState(!1),[he,ke]=N.useState(!1),[_e,ge]=N.useState({sikap:{monthId:void 0,chapterId:void 0},formatif:{monthId:void 0,chapterId:void 0},sumatif:{monthId:void 0,chapterId:void 0}}),be=N.useMemo(()=>$().format("YYYY-MM"),[]),ye=e=>{if(!e)return"";const t=String(e).match(/^(\d{4})-(\d{2})$/);if(!t)return String(e);return["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"][Number(t[2])-1]||String(e)};N.useEffect(()=>{ge(e=>({sikap:{...e.sikap,monthId:e.sikap.monthId||be},formatif:{...e.formatif,monthId:e.formatif.monthId||be},sumatif:{...e.sumatif,monthId:e.sumatif.monthId||be}}))},[be]);const je=_e.sikap?.monthId,Se=ye(je),{data:we}=u({subjectId:e?.id,classId:Y,month:Se,semester:ne},{skip:"sikap"!==X||!e?.id||!Y||!Se}),{data:xe}=c({subjectId:e?.id,classId:Y},{skip:!e?.id||!Y}),ve=xe?.data||[],Ne=_e[X]?.chapterId,{data:Ie}=m({chapterId:Ne},{skip:!Ne}),Ee=Ie?.data||[],Ae=N.useMemo(()=>ve.map(e=>String(e.id)===String(Ne)?{...e,contents:Ee}:{...e,contents:e.contents||[]}),[ve,Ne,Ee]),$e=N.useMemo(()=>Ae.find(e=>String(e.id)===String(Ne))||null,[Ae,Ne]),[Me,{isLoading:Ce}]=p(),[ze,{isLoading:Te}]=f(),[Ue,{isLoading:Fe}]=h(),[Be,{isLoading:Oe}]=k(),[Pe,{isLoading:Ke}]=_();N.useEffect(()=>{if(!ee?.data?.students)return oe([]),ue(!1),me(!1),fe(!1),void ke(!1);oe(ee.data.students.map(e=>({id:e.student_id,student_id:e.student_id,nis:e.nis,name:e.full_name,summary:{sikap:0,formatif:0,sumatif:0,ujianAkhir:0},formatifScores:{},summativeScores:{},attitude:{kinerja:0,kedisiplinan:0,keaktifan:0,percaya_diri:0,teacher_note:""}}))),ue(!1),me(!1),fe(!1),ke(!1)},[ee]),N.useEffect(()=>{if(!we?.data?.students)return;const e=new Map(we.data.students.map(e=>[String(e.student_id),e]));oe(t=>t.map(t=>{const a=e.get(String(t.student_id));return a?{...t,summary:{...t.summary,sikap:a.average_score??t.summary.sikap},attitude:{kinerja:a.kinerja??0,kedisiplinan:a.kedisiplinan??0,keaktifan:a.keaktifan??0,percaya_diri:a.percaya_diri??0,teacher_note:a.teacher_note||""}}:t})),ue(!1)},[we]);const Le=_e.formatif?.monthId,Re=ye(Le),Ge=_e.formatif?.chapterId,De=!(!Re||!Ge),{data:We}=g({subjectId:e?.id,classId:Y,month:Re,semester:ne,chapterId:Ge},{skip:!("formatif"===X&&e?.id&&Y&&Re&&Ge)}),He=N.useMemo(()=>V({students:We?.data?.students||[],isFormativeFilterActive:De,activeChapterId:Ne,activeChapter:$e,chaptersWithContents:Ae}),[We,De,Ne,$e,Ae]),Ve=N.useMemo(()=>{if(!De)return null;const e=new Set;return(We?.data?.students||[]).forEach(t=>{(t.scores||[]).forEach(t=>{const a=H(t?.type);null!=a&&e.add(a)})}),e.size?Math.max(...Array.from(e))+1:1},[We,De]);N.useEffect(()=>{"formatif"===X&&(Re&&Ge||(oe(e=>e.map(e=>({...e,summary:{...e.summary,formatif:0},formatifScores:{}}))),me(!1)))},[X,Re,Ge]),N.useEffect(()=>{if(!We?.data?.students)return;const e=new Map(We.data.students.map(e=>[String(e.student_id),e]));oe(t=>t.map(t=>{const a=e.get(String(t.student_id));if(!a)return t;const i=Array.isArray(a.scores)?a.scores:[],r={};return i.forEach(e=>{if(!e)return;const t=H(e.type),a=null==t&&/^M\d{2}-B\d+$/.test(String(e.type||""))?1:t,i=De?a??"default":e.type||`${e.month||"M00"}-B${e.chapter_id??"0"}-S${a??"0"}`;De&&"default"!==i&&Object.prototype.hasOwnProperty.call(r,i)||(r[i]=e.score??0)}),r.__new=0,{...t,summary:{...t.summary,formatif:De?a.score??t.summary.formatif:t.summary.formatif},formatifScores:r}})),me(!1)},[We]);const Ye=_e.sumatif?.monthId,Je=ye(Ye),qe=_e.sumatif?.chapterId,Qe=!(!Je||!qe),{data:Xe}=b({subjectId:e?.id,classId:Y,month:Je,semester:ne,chapterId:qe},{skip:!("sumatif"===X&&e?.id&&Y&&Je&&qe)}),Ze=N.useMemo(()=>V({students:Xe?.data?.students||[],isFormativeFilterActive:Qe,activeChapterId:Ne,activeChapter:$e,chaptersWithContents:Ae}),[Xe,Qe,Ne,$e,Ae]),et=N.useMemo(()=>{if(!Qe)return null;const e=new Set;return(Xe?.data?.students||[]).forEach(t=>{(t.scores||[]).forEach(t=>{const a=lt(t);null!=a&&e.add(a)})}),e.size?Math.max(...Array.from(e))+1:1},[Xe,Qe]);N.useEffect(()=>{"sumatif"===X&&(Je&&qe||(oe(e=>e.map(e=>({...e,summary:{...e.summary,sumatif:0},summativeScores:{}}))),fe(!1)))},[X,Je,qe]),N.useEffect(()=>{if(!Xe?.data?.students)return;const e=new Map(Xe.data.students.map(e=>[String(e.student_id),e]));oe(t=>t.map(t=>{const a=e.get(String(t.student_id));if(!a)return t;const i=Array.isArray(a.scores)?a.scores:[],r={};return i.forEach(e=>{if(!e)return;const t=lt(e),a=Qe?t??"default":e.type||`${e.month||"M00"}-B${e.chapter_id??"0"}-S${t??"0"}`;r[a]={score_written:e.score_written??0,score_skill:e.score_skill??0,final_score:e.final_score??ot(e.score_written,e.score_skill)}}),r.__new={score_written:0,score_skill:0,final_score:0},{...t,summary:{...t.summary,sumatif:Qe?a.score??dt(r):t.summary.sumatif},summativeScores:r}})),fe(!1)},[Xe,Qe]);const{data:tt}=y({subjectId:e?.id,classId:Y,semester:ne},{skip:"ujianAkhir"!==X||!e?.id||!Y});N.useEffect(()=>{if(!tt?.data?.students)return;const e=new Map(tt.data.students.map(e=>[String(e.student_id),e]));oe(t=>t.map(t=>{const a=e.get(String(t.student_id));return a?{...t,summary:{...t.summary,ujianAkhir:a.final_grade??0}}:t})),ke(!1)},[tt]);const at=(e,t,a)=>{oe(i=>{const r=[...i],s=r[e]||{};return r[e]={...s,summary:{...s.summary,[t]:a??0}},r}),"formatif"!==t?"ujianAkhir"===t&&ke(!0):me(!0)},it=(e,t,a)=>{oe(i=>{const r=[...i],s=r[e]||{},n=null===a?null:a??0,l={...s.formatifScores||{},[t??"default"]:n};return r[e]={...s,formatifScores:l,summary:{...s.summary,formatif:null!=t?l[t]??s.summary?.formatif:l.default??s.summary?.formatif}},r}),me(!0)},rt=(e,t,a)=>{oe(i=>{const r=[...i],s=r[e]||{},n=s.attitude||{},l="teacher_note"===t?a||"":a??0,o={...n,[t]:l},d=(Number(o.kinerja||0)+Number(o.kedisiplinan||0)+Number(o.keaktifan||0)+Number(o.percaya_diri||0))/4;return r[e]={...s,attitude:o,summary:{...s.summary,sikap:d}},r}),ue(!0)},st=(e,t,a,i)=>{oe(r=>{const s=[...r],n=s[e]||{},l=t??"default",o=n.summativeScores||{},d=o[l]||{},u=null===i?null:i??0,c={...d,[a]:u};c.final_score=ot(c.score_written,c.score_skill);const m={...o,[l]:c};return s[e]={...n,summativeScores:m,summary:{...n.summary,sumatif:dt(m)}},s}),fe(!0)},nt=e=>{const t=Number(e);return Number.isNaN(t)?0:Math.max(0,Math.min(100,Math.round(t)))};function lt(e){const t=Number(e?.subchapter_id);if(Number.isFinite(t)&&t>0)return t;const a=H(e?.type);if(null!=a)return a;const i=String(e?.type||"");return/^M\d{2}-B\d+$/.test(i)?1:null}const ot=(e,t)=>{const a=[null==e||""===e?null:nt(e),null==t||""===t?null:nt(t)].filter(e=>null!=e);return a.length?a.reduce((e,t)=>e+t,0)/a.length:0},dt=(e={})=>{const t=Object.entries(e).filter(([e])=>"__new"!==e).map(([,e])=>Number(e?.final_score??0)).filter(e=>!Number.isNaN(e)&&e>0);return t.length?t.reduce((e,t)=>e+t,0)/t.length:0},ut=(e,t,a)=>{ge(i=>{const r=i[e]||{};return{...i,[e]:{...r,[t]:a}}})},ct=async()=>{if(e?.id&&Y)try{const t=await Pe({subject_id:e.id,class_id:Y,semester:ne}).unwrap();v.success(t?.message||"Nilai ujian akhir berhasil dihapus."),oe(e=>e.map(e=>({...e,summary:{...e.summary,ujianAkhir:0}}))),ke(!1)}catch(t){v.error(t?.data?.message||"Gagal menghapus ujian akhir.")}else v.warning("Pilih kelas terlebih dahulu.")};return r.jsx(N.Suspense,{fallback:r.jsx(n,{style:{borderRadius:12},children:r.jsx(x,{active:!0,paragraph:{rows:5}})}),children:r.jsxs(j,{vertical:!0,gap:"middle",children:[r.jsx(re,{subject:e,unit:te,period:ae,semesterLabel:ie,classes:W,classId:Y,onClassChange:e=>J(e)}),r.jsx(n,{style:{borderRadius:14,border:"1px solid #f0f0f0"},styles:{body:{padding:12}},children:r.jsxs(j,{align:"center",justify:"space-between",wrap:"wrap",gap:12,children:[r.jsx("div",{style:{flex:1,minWidth:240},children:r.jsx(S,{activeKey:q,items:[{key:"semester1",label:"Semester 1"},{key:"semester2",label:"Semester 2"}],onChange:Q})}),r.jsx(z,{value:Y,placeholder:"Pilih kelas",options:W.map(e=>({label:e.name,value:e.id})),onChange:e=>J(e),disabled:!W.length,style:{minWidth:220}})]})}),L&&R&&Y?r.jsx(j,{vertical:!0,gap:16,children:r.jsxs(n,{style:{borderRadius:14,border:"1px solid #f0f0f0"},styles:{body:{padding:0}},children:[r.jsxs(j,{align:"center",justify:"space-between",wrap:"wrap",gap:12,style:{padding:16},children:[r.jsxs("div",{children:[r.jsx(a.Title,{level:5,style:{margin:0},children:"Input Penilaian"}),r.jsx(a.Text,{type:"secondary",children:"Pilih tab penilaian, atur filter bulan/bab/subbab, lalu isi nilai siswa."})]}),"sikap"===X&&r.jsxs(j,{align:"center",gap:8,wrap:"wrap",children:[r.jsx(w,{icon:r.jsx(T,{size:16}),onClick:()=>{if(!le.length)return void v.warning("Belum ada data siswa untuk dibuatkan template.");const e=le.map(e=>({NIS:e.nis||"",Nama:e.name||"",Kinerja:e.attitude?.kinerja??0,Kedisiplinan:e.attitude?.kedisiplinan??0,Keaktifan:e.attitude?.keaktifan??0,"Percaya Diri":e.attitude?.percaya_diri??0,Catatan:e.attitude?.teacher_note||""})),t=I.json_to_sheet(e,{header:["NIS","Nama","Kinerja","Kedisiplinan","Keaktifan","Percaya Diri","Catatan"]}),a=I.book_new();I.book_append_sheet(a,t,"Template Sikap");const i=`Template_Nilai_Sikap_${W.find(e=>String(e.id)===String(Y))?.name||"Kelas"}${Se?`_${Se}`:""}`.replace(/[\/:*?"<>|]/g,"-");E(a,`${i}.xlsx`)},children:"Template Sikap"}),r.jsx(U,{accept:".xlsx,.xls",showUploadList:!1,beforeUpload:e=>{if(!je)return v.warning("Pilih bulan sikap terlebih dahulu sebelum upload."),!1;if(!le.length)return v.warning("Belum ada data siswa untuk diisi."),!1;const t=new Set(le.map(e=>String(e.nis||"").trim())),a=new FileReader;return a.onload=e=>{try{const a=new Uint8Array(e.target.result),i=A(a,{type:"array"}),r=i.SheetNames[0],s=I.sheet_to_json(i.Sheets[r],{defval:""});if(!s.length)return void v.error("File Excel kosong atau format tidak sesuai.");const n=new Map;let l=0;if(s.forEach(e=>{const a=Object.entries(e).reduce((e,[t,a])=>{const i=String(t||"").trim().toLowerCase();return i&&(e[i]=a),e},{}),i=a.nis||a["no induk"]||a.no_induk,r=String(i||"").trim();if(!r)return;if(!t.has(r))return void(l+=1);const s=nt(a.kinerja),o=nt(a.kedisiplinan),d=nt(a.keaktifan),u=nt(a["percaya diri"]??a.percaya_diri),c=a.catatan??a.teacher_note??a.note??"";n.set(r,{kinerja:s,kedisiplinan:o,keaktifan:d,percaya_diri:u,teacher_note:c?String(c):""})}),0===n.size)return void v.error("Tidak ada baris valid pada file Excel.");oe(e=>e.map(e=>{const t=String(e.nis||"").trim();if(!n.has(t))return e;const a=n.get(t),i={...e.attitude,...a},r=(Number(i.kinerja||0)+Number(i.kedisiplinan||0)+Number(i.keaktifan||0)+Number(i.percaya_diri||0))/4;return{...e,attitude:i,summary:{...e.summary,sikap:r}}})),ue(!0),l>0?v.warning(`Upload selesai. ${l} NIS tidak ditemukan di kelas ini.`):v.success("Upload nilai sikap berhasil diterapkan.")}catch(a){v.error("Gagal membaca file Excel.")}},a.readAsArrayBuffer(e),!1},children:r.jsx(w,{icon:r.jsx(F,{size:16}),children:"Upload Excel"})}),r.jsx(w,{type:"primary",icon:r.jsx(B,{size:16}),loading:Ce,disabled:!de,onClick:async()=>{if(!e?.id||!Y||!Se)return void v.warning("Pilih bulan sikap terlebih dahulu.");const t=le.map(e=>({student_id:e.student_id,kinerja:e.attitude?.kinerja??0,kedisiplinan:e.attitude?.kedisiplinan??0,keaktifan:e.attitude?.keaktifan??0,percaya_diri:e.attitude?.percaya_diri??0,teacher_note:e.attitude?.teacher_note||""}));try{const a=await Me({subject_id:e.id,class_id:Y,month:Se,semester:ne,items:t}).unwrap();v.success(a?.message||"Nilai sikap tersimpan."),ue(!1)}catch(a){v.error(a?.data?.message||"Gagal menyimpan nilai sikap.")}},children:"Simpan Sikap"})]}),"formatif"===X&&r.jsxs(j,{align:"center",gap:8,wrap:"wrap",children:[r.jsx(w,{icon:r.jsx(T,{size:16}),onClick:()=>{if(!Re||!Ge)return void v.warning("Pilih bulan dan bab formatif terlebih dahulu.");if(!le.length)return void v.warning("Belum ada data siswa untuk dibuatkan template.");const e=le.map(e=>{const t={NIS:e.nis||"",Nama:e.name||""};return t["Input Nilai"]=e.formatifScores?.__new??0,t}),t=I.json_to_sheet(e,{header:["NIS","Nama","Input Nilai"]}),a=I.book_new();I.book_append_sheet(a,t,"Template Formatif");const i=`Template_Nilai_Formatif_${W.find(e=>String(e.id)===String(Y))?.name||"Kelas"}_${ve.find(e=>String(e.id)===String(Ge))?.title||"Bab"}_InputNilai${Re?`_${Re}`:""}`.replace(/[\/:*?"<>|]/g,"-");E(a,`${i}.xlsx`)},children:"Template Formatif"}),r.jsx(U,{accept:".xlsx,.xls",showUploadList:!1,beforeUpload:e=>{if(!Re||!Ge)return v.warning("Pilih bulan dan bab formatif terlebih dahulu sebelum upload."),!1;if(!le.length)return v.warning("Belum ada data siswa untuk diisi."),!1;const t=new Set(le.map(e=>String(e.nis||"").trim())),a=new FileReader;return a.onload=e=>{try{const a=new Uint8Array(e.target.result),i=A(a,{type:"array"}),r=i.SheetNames[0],s=I.sheet_to_json(i.Sheets[r],{defval:""});if(!s.length)return void v.error("File Excel kosong atau format tidak sesuai.");const n=new Map;let l=0;if(s.forEach(e=>{const a=Object.entries(e).reduce((e,[t,a])=>{const i=String(t||"").trim().toLowerCase();return i&&(e[i]=a),e},{}),i=a.nis||a["no induk"]||a.no_induk,r=String(i||"").trim();if(!r)return;if(!t.has(r))return void(l+=1);const s=Object.keys(a).filter(e=>/^nilai\s*\d+$/i.test(e));if(s.length){const e={};if(s.forEach(t=>{const i=t.match(/\d+/),r=i?Number(i[0]):null;if(!r)return;const s=a[t];null!=s&&""!==s&&(e[r]=nt(s))}),Object.keys(e).length)return void n.set(r,e)}const o=a["input nilai"]??a.nilai??a.score??a.formatif??null;null!=o&&n.set(r,nt(o))}),0===n.size)return void v.error("Tidak ada baris valid pada file Excel.");oe(e=>e.map(e=>{const t=String(e.nis||"").trim();if(!n.has(t))return e;const a=n.get(t),i={...e.formatifScores||{}};return"object"==typeof a&&null!==a?Object.entries(a).forEach(([e,t])=>{i[Number(e)]=t}):i.__new=a,{...e,formatifScores:i}})),me(!0),l>0?v.warning(`Upload selesai. ${l} NIS tidak ditemukan di kelas ini.`):v.success("Upload nilai formatif berhasil diterapkan.")}catch(a){v.error("Gagal membaca file Excel.")}},a.readAsArrayBuffer(e),!1},children:r.jsx(w,{icon:r.jsx(F,{size:16}),children:"Upload Excel"})}),r.jsx(w,{type:"primary",icon:r.jsx(B,{size:16}),loading:Te,disabled:!ce,onClick:async()=>{if(!(e?.id&&Y&&Re&&Ge))return void v.warning("Pilih bulan dan bab formatif terlebih dahulu.");if(!Ve)return void v.warning("Nilai formatif baru belum bisa ditentukan.");const t=[];le.forEach(e=>{He.forEach(a=>{const i=e.formatifScores?.[a.id],r=null==i?null:nt(i);t.push({student_id:e.student_id,subchapter_id:a.id,score:r})});const a=e.formatifScores?.__new;if(null!=a&&""!==a){const i=nt(a);t.push({student_id:e.student_id,subchapter_id:Ve,score:i})}});try{const a=await ze({subject_id:e.id,class_id:Y,month:Re,semester:ne,chapter_id:Ge,items:t}).unwrap();v.success(a?.message||"Nilai formatif tersimpan."),oe(e=>e.map(e=>({...e,formatifScores:{...e.formatifScores||{},__new:0}}))),me(!1)}catch(a){v.error(a?.data?.message||"Gagal menyimpan nilai formatif.")}},children:"Simpan Formatif"})]}),"sumatif"===X&&r.jsxs(j,{align:"center",gap:8,wrap:"wrap",children:[r.jsx(w,{icon:r.jsx(T,{size:16}),onClick:()=>{if(!Je||!qe)return void v.warning("Pilih bulan dan bab sumatif terlebih dahulu.");if(!le.length)return void v.warning("Belum ada data siswa untuk dibuatkan template.");const e=le.map(e=>({NIS:e.nis||"",Nama:e.name||"","Nilai Tertulis":e.summativeScores?.__new?.score_written??0,"Nilai Praktik":e.summativeScores?.__new?.score_skill??0})),t=I.json_to_sheet(e,{header:["NIS","Nama","Nilai Tertulis","Nilai Praktik"]}),a=I.book_new();I.book_append_sheet(a,t,"Template Sumatif");const i=`Template_Nilai_Sumatif_${W.find(e=>String(e.id)===String(Y))?.name||"Kelas"}_${ve.find(e=>String(e.id)===String(qe))?.title||"Bab"}_InputNilai${Je?`_${Je}`:""}`.replace(/[\/:*?"<>|]/g,"-");E(a,`${i}.xlsx`)},children:"Template Sumatif"}),r.jsx(U,{accept:".xlsx,.xls",showUploadList:!1,beforeUpload:e=>{if(!Je||!qe)return v.warning("Pilih bulan dan bab sumatif terlebih dahulu sebelum upload."),!1;if(!le.length)return v.warning("Belum ada data siswa untuk diisi."),!1;const t=new Set(le.map(e=>String(e.nis||"").trim())),a=new FileReader;return a.onload=e=>{try{const a=new Uint8Array(e.target.result),i=A(a,{type:"array"}),r=i.SheetNames[0],s=I.sheet_to_json(i.Sheets[r],{defval:""});if(!s.length)return void v.error("File Excel kosong atau format tidak sesuai.");const n=new Map;let l=0;if(s.forEach(e=>{const a=Object.entries(e).reduce((e,[t,a])=>{const i=String(t||"").trim().toLowerCase();return i&&(e[i]=a),e},{}),i=a.nis||a["no induk"]||a.no_induk,r=String(i||"").trim();if(!r)return;if(!t.has(r))return void(l+=1);const s=nt(a["nilai tertulis"]??a.tertulis??a.score_written??a["nilai tulis"]??0),o=nt(a["nilai praktik"]??a.praktik??a.praktek??a.score_skill??0);n.set(r,{score_written:s,score_skill:o,final_score:ot(s,o)})}),0===n.size)return void v.error("Tidak ada baris valid pada file Excel.");oe(e=>e.map(e=>{const t=String(e.nis||"").trim();if(!n.has(t))return e;const a=n.get(t),i={...e.summativeScores||{},__new:a};return{...e,summativeScores:i}})),fe(!0),l>0?v.warning(`Upload selesai. ${l} NIS tidak ditemukan di kelas ini.`):v.success("Upload nilai sumatif berhasil diterapkan.")}catch(a){v.error("Gagal membaca file Excel.")}},a.readAsArrayBuffer(e),!1},children:r.jsx(w,{icon:r.jsx(F,{size:16}),children:"Upload Excel"})}),r.jsx(w,{type:"primary",icon:r.jsx(B,{size:16}),loading:Fe,disabled:!pe,onClick:async()=>{if(!(e?.id&&Y&&Je&&qe))return void v.warning("Pilih bulan dan bab sumatif terlebih dahulu.");if(!et)return void v.warning("Nilai sumatif baru belum bisa ditentukan.");const t=[];if(le.forEach(e=>{Ze.forEach(a=>{const i=e.summativeScores?.[a.id]||{},r=null===i.score_written||void 0===i.score_written||""===i.score_written?null:nt(i.score_written),s=null===i.score_skill||void 0===i.score_skill||""===i.score_skill?null:nt(i.score_skill);t.push({student_id:e.student_id,subchapter_id:a.id,score_written:r,score_skill:s})});const a=e.summativeScores?.__new||{},i=null===a.score_written||void 0===a.score_written||""===a.score_written?null:nt(a.score_written),r=null===a.score_skill||void 0===a.score_skill||""===a.score_skill?null:nt(a.score_skill);null==i&&null==r||t.push({student_id:e.student_id,subchapter_id:et,score_written:i,score_skill:r})}),t.length)try{const a=await Ue({subject_id:e.id,class_id:Y,month:Je,semester:ne,chapter_id:qe,items:t}).unwrap();v.success(a?.message||"Nilai sumatif tersimpan."),oe(e=>e.map(e=>({...e,summativeScores:{...e.summativeScores||{},__new:{score_written:0,score_skill:0,final_score:0}}}))),fe(!1)}catch(a){v.error(a?.data?.message||"Gagal menyimpan nilai sumatif.")}else v.warning("Belum ada nilai sumatif yang dapat disimpan.")},children:"Simpan Sumatif"})]}),"ujianAkhir"===X&&r.jsxs(j,{align:"center",gap:8,wrap:"wrap",children:[r.jsx(w,{icon:r.jsx(T,{size:16}),onClick:()=>{if(!le.length)return void v.warning("Belum ada data siswa untuk dibuatkan template.");const e=le.map(e=>({NIS:e.nis||"",Nama:e.name||"","Nilai Ujian Akhir":e.summary?.ujianAkhir??0})),t=I.json_to_sheet(e,{header:["NIS","Nama","Nilai Ujian Akhir"]}),a=I.book_new();I.book_append_sheet(a,t,"Template Ujian Akhir");const i=`Template_Nilai_UjianAkhir_${W.find(e=>String(e.id)===String(Y))?.name||"Kelas"}_Semester${ne}`.replace(/[\/:*?"<>|]/g,"-");E(a,`${i}.xlsx`)},children:"Template Ujian Akhir"}),r.jsx(U,{accept:".xlsx,.xls",showUploadList:!1,beforeUpload:e=>{if(!le.length)return v.warning("Belum ada data siswa untuk diisi."),!1;const t=new Set(le.map(e=>String(e.nis||"").trim())),a=new FileReader;return a.onload=e=>{try{const a=new Uint8Array(e.target.result),i=A(a,{type:"array"}),r=i.SheetNames[0],s=I.sheet_to_json(i.Sheets[r],{defval:""});if(!s.length)return void v.error("File Excel kosong atau format tidak sesuai.");const n=new Map;let l=0;if(s.forEach(e=>{const a=Object.entries(e).reduce((e,[t,a])=>{const i=String(t||"").trim().toLowerCase();return i&&(e[i]=a),e},{}),i=a.nis||a["no induk"]||a.no_induk,r=String(i||"").trim();if(!r)return;if(!t.has(r))return void(l+=1);const s=a["nilai ujian akhir"]??a["ujian akhir"]??a["nilai akhir"]??a.final??a["final grade"]??a.final_grade??a.nilai??a.score;null!=s&&""!==s&&n.set(r,nt(s))}),0===n.size)return void v.error("Tidak ada baris valid pada file Excel.");oe(e=>e.map(e=>{const t=String(e.nis||"").trim();return n.has(t)?{...e,summary:{...e.summary||{},ujianAkhir:n.get(t)}}:e})),ke(!0),l>0?v.warning(`Upload selesai. ${l} NIS tidak ditemukan di kelas ini.`):v.success("Upload nilai ujian akhir berhasil diterapkan.")}catch(a){v.error("Gagal membaca file Excel.")}},a.readAsArrayBuffer(e),!1},children:r.jsx(w,{icon:r.jsx(F,{size:16}),children:"Upload Excel"})}),r.jsx(w,{danger:!0,icon:r.jsx(P,{}),loading:Ke,onClick:()=>{O.confirm({title:"Hapus semua nilai ujian akhir?",icon:r.jsx(D,{}),content:"Semua nilai Ujian Akhir pada kelas dan semester ini akan dihapus.",okText:"Hapus",okType:"danger",cancelText:"Batal",onOk:ct})},children:"Hapus Nilai"}),r.jsx(w,{type:"primary",icon:r.jsx(B,{size:16}),loading:Oe,disabled:!he,onClick:async()=>{if(!e?.id||!Y)return void v.warning("Pilih kelas terlebih dahulu.");const t=le.map(e=>{const t=e.summary?.ujianAkhir,a=null==t||""===t?null:nt(t);return{student_id:e.student_id,final_grade:0===a?null:a}});try{const a=await Be({subject_id:e.id,class_id:Y,semester:ne,items:t}).unwrap();v.success(a?.message||"Nilai ujian akhir tersimpan."),ke(!1)}catch(a){v.error(a?.data?.message||"Gagal menyimpan ujian akhir.")}},children:"Simpan Ujian Akhir"})]})]}),r.jsx(S,{activeKey:X,items:[{key:"sikap",label:"Sikap"},{key:"formatif",label:"Formatif"},{key:"sumatif",label:"Sumatif"},{key:"ujianAkhir",label:"Ujian Akhir"}].map(e=>{return{key:e.key,label:e.label,children:(t=e.key,r.jsx(se,{students:le,chapters:Ae,typeKey:t,filters:_e[t],onFilterChange:ut,onStudentChange:at,onFormativeChange:it,formativeSubchapters:He,onSummativeChange:st,summativeSubchapters:Ze,onAttitudeChange:rt,showFilters:"ujianAkhir"!==t}))};var t}),onChange:Z,style:{padding:"0 16px 16px"}})]})}):r.jsx(n,{style:{borderRadius:14,border:"1px solid #f0f0f0"},styles:{body:{padding:24}},children:r.jsx(K,{description:"Belum ada data penilaian pada semester ini."})})]})})}},Symbol.toStringTag,{value:"Module"}));export{ne as G,ie as S};
